<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memory card game</title>
  <link rel="stylesheet" href="styles.css" />
</head><body draggable="false">
  <div id="board">
    <div id="row1"></div>
    <div id="row2"></div>
    <div id="row3"></div>
  </div>
  <div id="pointer"></div>
  <script>
    const shuffleArray = array => {
      // Fisherâ€“Yates shuffle
      for (let iterator = array.length - 1; iterator > 0; iterator--) {
        const switchWith = Math.floor(Math.random() * (iterator + 1));
        [array[iterator], array[switchWith]] = [array[switchWith], array[iterator]]
      }
      return array
    }

    const setupPointer = () => {
      document.body.classList.add('customCursor')
      document.getElementById('pointer').innerHTML = `
        <img class="hidden" src="./assets/pointing-hand.png" draggable="false" />
      `
      window.addEventListener('contextmenu', event => {
        event.preventDefault()
      })
      const pointer = document.getElementById('pointer')
      const pointerImage = document.querySelector('#pointer > img')
      const pointingHandPointerOffset = {
        x: 70,
        y: 15
      }
      const pointerMaxRotation = 25 // in degrees
      pointer.style.transformOrigin = `${pointingHandPointerOffset.x}px ${pointingHandPointerOffset.y}px`
      window.addEventListener('mousemove', event => {
        const viewportWidth = window.innerWidth
        const {clientX: x, clientY: y} = event
        const xFromCenter = ((x / viewportWidth) * 2) - 1 // within [-1, 1]
        const translateX = `${x - pointingHandPointerOffset.x}px`
        const translateY = `${y - pointingHandPointerOffset.y}px`
        const rotation = `${xFromCenter * pointerMaxRotation}deg`
        const vmin = Math.min(window.innerWidth, window.innerHeight)
        const scaleFactor = vmin / 1440
        pointer.style.transform = `
          translate(${translateX}, ${translateY})
          rotate(${rotation})
          scale(${scaleFactor.toFixed(4)})
        `
      });
      window.addEventListener('mousemove', () => {
        document.querySelector('#pointer > img').classList.remove('hidden')
      }, {once: true})

      window.addEventListener('mousedown', e => {
        pointerImage.src = "./assets/tapping-hand.png"
      });

      window.addEventListener('mouseup', e => {
        pointerImage.src = "./assets/pointing-hand.png"
      });
    }

    const colors = ["#2f5755", "#54c6be", "#f7b15c", "#f65c51", "#e5243f"]

    const decks = [
      ["steam-locomotive", "bulldozer", "bus", "mine-truck", "ambulance"],
      ["dimetrodon", "diplodocus", "pterodactylus", "triceratops-head", "velociraptor"],
      ["hand-saw", "spade", "3d-hammer", "drill", "spanner"],
      ["shiny-apple", "grapes", "pear", "banana", "cherry"],
      ["travel-dress", "underwear-shorts", "socks", "winter-gloves", "winter-hat"],
      ["rocket", "space-suit", "earth-africa-europe", "rainbow-star", "moon"]
    ]

    const handleDeckSelection = selectedDeckIndex => {
      document.querySelectorAll('.card').forEach(card => {
        card.dataset.transition="fadingOut"
      })
      setTimeout(() => {
        setupBoard(selectedDeckIndex)
      }, 815)
    }

    const setupDeckSelection = () => {
      const renderDeckSelector = card => `
        <button
          class="card"
          data-state="selected"
          data-deck-index="${card.index}"
        >
          <div class="front">
            <img
              src="./assets/faces/${card.face}.svg"
              draggable="false"
            />
          </div>
        </button>
      `

      const selectors = (
        decks
          .map(([firstCard]) => firstCard)
          .map((card, cardIndex) => ({
            index: cardIndex,
            face: card
          }))
      )
      const row1 = document.getElementById("row1")
      const row2 = document.getElementById("row2")
      const row3 = document.getElementById("row3")
      row1.innerHTML = selectors.slice(0, 3).map(renderDeckSelector).join('')
      row2.innerHTML = ''
      row3.innerHTML = selectors.slice(3, 6).map(renderDeckSelector).join('')

      document.querySelectorAll('.card').forEach(card => {
        const selectedDeckIndex = +(card.dataset.deckIndex)
        card.addEventListener('click', () => handleDeckSelection(selectedDeckIndex))
        card.addEventListener('contextmenu', () => handleDeckSelection(selectedDeckIndex))
        card.addEventListener('auxclick', () => handleDeckSelection(selectedDeckIndex))
      })
    }

    const handleCardClick = event => {
      event.preventDefault()
      const cardClicked = event.composedPath().find(element => (
        [...element.classList].includes("card"))
      )
      if (cardClicked.dataset.state === "hidden") {
        const selectedCards = [...document.querySelectorAll('.card[data-state="selected"]')]
        if (selectedCards.length < 2) {
          cardClicked.dataset.state = "selected"
        }
        if (selectedCards.length === 1) {
          const [selectedCard] = selectedCards
          if (selectedCard.dataset.value === cardClicked.dataset.value) {
            setTimeout(() => {
              [cardClicked, selectedCard].forEach(card => {
                card.dataset.state = "found"
                card.disabled = "disabled"
              })
              const foundCards = [...document.querySelectorAll('.card[data-state="found"]')]
              if (foundCards.length === 10) {
                setTimeout(() => {
                  setupDeckSelection()
                }, 5000)
              }
            }, 1000)
          }
          else {
            setTimeout(() => {
              [cardClicked, selectedCard].forEach(card => {
                card.dataset.state = "hidden"
              })
            }, 3000)
          }
        }
      }
    }

    const setupBoard = (selectedDeckIndex) => {
      const faces = decks[selectedDeckIndex]
      const renderCard = card => `
        <button
          class="card"
          data-value="${card.face}"
          data-state="hidden"
        >
          <div
            class="front"
            style="background-color: ${card.color};"
          >
            <img
              src="./assets/faces/${card.face}.svg"
              draggable="false"
            />
          </div>
          <div class="back">
            <img
              src="./assets/faces/perspective-dice-six-faces-random.svg"
              draggable="false"
            />
          </div>
        </button>
      `
      const deck = (
        faces
          .map((card, cardIndex) => ({
            id: cardIndex,
            face: card,
            color: colors[cardIndex]
          }))
      )
      const fullDeck = [...deck, ...deck]
      const shuffledDeck = shuffleArray(fullDeck)
      const row1 = document.getElementById("row1")
      const row2 = document.getElementById("row2")
      const row3 = document.getElementById("row3")
      row1.innerHTML = shuffledDeck.slice(0, 3).map(renderCard).join('')
      row2.innerHTML = shuffledDeck.slice(3, 7).map(renderCard).join('')
      row3.innerHTML = shuffledDeck.slice(7, 10).map(renderCard).join('')
      document.querySelectorAll('.card').forEach(card => {
        card.addEventListener('click', handleCardClick)
        card.addEventListener('contextmenu', handleCardClick)
        card.addEventListener('auxclick', handleCardClick)
      })
    }

    if (!('ontouchstart' in window)) {
      setupPointer()
    }
    setupDeckSelection()
  </script>
</body></html>
